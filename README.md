# ICæ¨¡æ‹Ÿå™¨é¡¹ç›® - é€šç”¨ç¡¬ä»¶ä»¿çœŸå¹³å°

## é¡¹ç›®æ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ªé‡‡ç”¨**åˆ†å±‚è§£è€¦**è®¾è®¡çš„é€šç”¨ICæ¨¡æ‹Ÿå™¨ï¼Œå®ç°äº†é©±åŠ¨é€æ˜æ€§å’Œæ’ä»¶åŒ–ç¡¬ä»¶ä»¿çœŸã€‚é€šè¿‡å†…å­˜ä¿æŠ¤æœºåˆ¶å’Œä¿¡å·å¤„ç†æŠ€æœ¯ï¼Œé©±åŠ¨ç¨‹åºå¯ä»¥åƒè®¿é—®çœŸå®ç¡¬ä»¶ä¸€æ ·å·¥ä½œï¼Œæ— éœ€ä»»ä½•ä¿®æ”¹ã€‚

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### åˆ†å±‚æ¶æ„
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åº”ç”¨å±‚ (main.c)                      â”‚
â”‚              ç³»ç»Ÿåˆå§‹åŒ– + æµ‹è¯•ç”¨ä¾‹æ‰§è¡Œ                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   é©±åŠ¨å±‚ (Driver Layer)                  â”‚
â”‚      UART Driver + Interrupt Manager + é™æ€é…ç½®          â”‚
â”‚           (é€æ˜çš„å¯„å­˜å™¨è®¿é—® + ä¸­æ–­å¤„ç†)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              æ¥å£å±‚ (Sim Interface Layer)                â”‚
â”‚     å†…å­˜ä¿æŠ¤ + ä¿¡å·å¤„ç† + å¯„å­˜å™¨æ˜ å°„ + ä¸­æ–­è·¯ç”±            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               æ¨¡æ‹Ÿå™¨å±‚ (Simulator Layer)                 â”‚
â”‚            æ’ä»¶ç®¡ç† + ç¡¬ä»¶è¡Œä¸ºæ¨¡æ‹Ÿ                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ¯ æ ¸å¿ƒè®¾è®¡åŸåˆ™

#### 1. **é©±åŠ¨é€æ˜æ€§**
- é©±åŠ¨ç¨‹åºå¯ä»¥åƒè®¿é—®çœŸå®ç¡¬ä»¶ä¸€æ ·å·¥ä½œï¼Œæ— éœ€ä¿®æ”¹
- é€šè¿‡å†…å­˜ä¿æŠ¤(mmap + PROT_NONE)æ‹¦æˆªå¯„å­˜å™¨è®¿é—®
- é©±åŠ¨ä»£ç ä¸æ¨¡æ‹Ÿå™¨å®Œå…¨è§£è€¦

#### 2. **ä¸­æ–­æ¶æ„åˆ†ç¦»** 
```c
// é©±åŠ¨å±‚ï¼šåªè´Ÿè´£æ³¨å†Œä¸­æ–­å¤„ç†å‡½æ•°
register_interrupt_handler(5, uart_tx_interrupt_handler);

// ä¸»ç¨‹åºï¼šè´Ÿè´£ä¿¡å·åˆ°ä¸­æ–­çš„æ˜ å°„  
{34, "uart", 5},  // ä¿¡å·34 -> IRQ 5

// æ¥å£å±‚ï¼šè´Ÿè´£ä¿¡å·å¤„ç†å’Œä¸­æ–­è·¯ç”±
handle_interrupt(mapping->irq_num);
```

#### 3. **é™æ€é…ç½®è¡¨**
```c
// å¯„å­˜å™¨æ˜ å°„è¡¨
static const struct {
    uint32_t start_addr, end_addr;
    const char *module;
} register_mappings[] = {
    {0x40001000, 0x40001050, "uart"},
};

// ä¿¡å·æ˜ å°„è¡¨
static const struct {
    int signal_num;
    const char *module; 
    uint32_t irq_num;
} signal_mappings[] = {
    {34, "uart", 5},  // TXä¸­æ–­
    {35, "uart", 6},  // RXä¸­æ–­
};
```

### ğŸ§© æ ¸å¿ƒç»„ä»¶

1. **é©±åŠ¨å±‚** (`src/driver/`)
   - **UART Driver**: æ ‡å‡†UARTé©±åŠ¨å®ç°ï¼Œç›´æ¥è®¿é—®å¯„å­˜å™¨åœ°å€
   - **Interrupt Manager**: ä¸­æ–­ç®¡ç†å™¨ï¼Œç»Ÿä¸€ç®¡ç†IRQåˆ°å¤„ç†å‡½æ•°çš„æ˜ å°„
   - æ— éœ€ä¿®æ”¹å³å¯ç”¨äºä»¿çœŸå’ŒçœŸå®ç¡¬ä»¶

2. **æ¥å£å±‚** (`src/sim_interface/`)
   - **å†…å­˜ä¿æŠ¤**: ä½¿ç”¨mmapè®¾ç½®PROT_NONEæ‹¦æˆªå¯„å­˜å™¨è®¿é—®
   - **ä¿¡å·å¤„ç†**: æ•è·SIGSEGVå¹¶è§£æè®¿é—®æ„å›¾
   - **ä¸­æ–­è·¯ç”±**: å°†ä¿¡å·æ˜ å°„åˆ°IRQå·å¹¶è°ƒç”¨interrupt_manager
   - **æ¨¡å—è§£è€¦**: é€šè¿‡å­—ç¬¦ä¸²æ¨¡å—åå®ç°æ¾è€¦åˆ

3. **æ¨¡æ‹Ÿå™¨å±‚** (`src/simulator/`)
   - **æ’ä»¶æ¶æ„**: æ¯ä¸ªç¡¬ä»¶æ¨¡å—ä½œä¸ºç‹¬ç«‹æ’ä»¶
   - **æ¶ˆæ¯é©±åŠ¨**: é€šè¿‡æ ‡å‡†æ¶ˆæ¯åè®®é€šä¿¡
   - **è¡Œä¸ºæ¨¡æ‹Ÿ**: å®ç°çœŸå®ç¡¬ä»¶çš„åŠŸèƒ½é€»è¾‘

4. **åº”ç”¨å±‚** (`src/main.c`)
   - **é™æ€é…ç½®**: ç¼–è¯‘æ—¶é…ç½®å¯„å­˜å™¨å’Œä¸­æ–­æ˜ å°„
   - **ç³»ç»Ÿåˆå§‹åŒ–**: ä¸€é”®åˆå§‹åŒ–æ‰€æœ‰ç»„ä»¶
   - **æµ‹è¯•æ¡†æ¶**: æ¨¡å—åŒ–çš„æµ‹è¯•ç”¨ä¾‹

5. **é€šç”¨åè®®** (`src/common/`)
   - æ ‡å‡†åŒ–çš„æ¶ˆæ¯åè®®å®šä¹‰
   - è·¨å±‚é€šä¿¡çš„æ•°æ®ç»“æ„

## ğŸ“‹ é€šä¿¡åè®®

æ”¯æŒä»¥ä¸‹æ¶ˆæ¯ç±»å‹ï¼š
- `MSG_CLOCK`: æ—¶é’Ÿæ§åˆ¶ (å¯ç”¨/ç¦ç”¨/æ—¶é’Ÿå‘¨æœŸ)
- `MSG_RESET`: å¤ä½æ§åˆ¶ (æ‹‰é«˜/æ‹‰ä½å¤ä½ä¿¡å·)
- `MSG_REG_READ`: å¯„å­˜å™¨è¯»å–
- `MSG_REG_WRITE`: å¯„å­˜å™¨å†™å…¥  
- `MSG_INTERRUPT`: ä¸­æ–­å¤„ç†
- `MSG_RESPONSE`: å“åº”æ¶ˆæ¯

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¼–è¯‘ç¯å¢ƒè¦æ±‚
- GCC ç¼–è¯‘å™¨
- Linux/WSLç¯å¢ƒ (æ”¯æŒPOSIXä¿¡å·)
- Make æ„å»ºå·¥å…·

### ç¼–è¯‘
```bash
make clean && make
```

### è¿è¡Œæµ‹è¯•
```bash
make run
# æˆ–è€…ç›´æ¥è¿è¡Œ
./bin/ic_simulator
```

### æ¸…ç†
```bash
make clean
```

## ğŸ“‚ é¡¹ç›®ç»“æ„

```
NewICD2/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ common/
â”‚   â”‚   â””â”€â”€ protocol.h              # é€šä¿¡åè®®å®šä¹‰
â”‚   â”œâ”€â”€ driver/
â”‚   â”‚   â”œâ”€â”€ uart_driver.h/.c        # UARTé©±åŠ¨å®ç°
â”‚   â”‚   â””â”€â”€ interrupt_manager.h/.c  # ä¸­æ–­ç®¡ç†å™¨
â”‚   â”œâ”€â”€ sim_interface/
â”‚   â”‚   â”œâ”€â”€ sim_interface.h/.c      # ä»¿çœŸæ¥å£å±‚
â”‚   â”‚   â””â”€â”€ plugin_manager.c        # æ’ä»¶ç®¡ç†å™¨  
â”‚   â”œâ”€â”€ simulator/
â”‚   â”‚   â”œâ”€â”€ plugin_interface.h      # æ’ä»¶æ¥å£å®šä¹‰
â”‚   â”‚   â””â”€â”€ plugins/
â”‚   â”‚       â””â”€â”€ uart_plugin.c       # UARTä»¿çœŸæ’ä»¶
â”‚   â””â”€â”€ main.c                      # ä¸»ç¨‹åºå’Œé™æ€é…ç½®
â”œâ”€â”€ build/                          # ç¼–è¯‘ä¸­é—´æ–‡ä»¶
â”œâ”€â”€ bin/                            # å¯æ‰§è¡Œæ–‡ä»¶
â”œâ”€â”€ Makefile                        # æ„å»ºè„šæœ¬
â””â”€â”€ README.md                       # é¡¹ç›®æ–‡æ¡£
```

## ğŸ”§ æ‰©å±•æ–°ç¡¬ä»¶æ¨¡å—

### æ·»åŠ æ–°å¤–è®¾çš„æ­¥éª¤ (ä»¥SPIä¸ºä¾‹)

#### 1. æ›´æ–°é™æ€é…ç½®è¡¨
```c
// main.c - æ·»åŠ å¯„å­˜å™¨æ˜ å°„
static const struct {
    uint32_t start_addr, end_addr;
    const char *module;
} register_mappings[] = {
    {0x40001000, 0x40001050, "uart"},
    {0x40002000, 0x40002050, "spi"},    // æ–°å¢SPI
};

// main.c - æ·»åŠ ä¸­æ–­æ˜ å°„  
static const struct {
    int signal_num;
    const char *module;
    uint32_t irq_num; 
} signal_mappings[] = {
    {34, "uart", 5}, {35, "uart", 6},
    {36, "spi", 7},     // æ–°å¢SPIä¸­æ–­
};
```

#### 2. åˆ›å»ºSPIé©±åŠ¨
```c
// src/driver/spi_driver.c
#include "interrupt_manager.h"

void spi_tx_interrupt_handler(void) {
    // SPIå‘é€ä¸­æ–­å¤„ç†é€»è¾‘
}

int spi_init(void) {
    register_interrupt_handler(7, spi_tx_interrupt_handler);
    return 0;
}
```

#### 3. åˆ›å»ºSPIæ’ä»¶
```c
// src/simulator/plugins/spi_plugin.c
static int spi_handle_register(simulator_plugin_t *plugin, 
                              const sim_message_t *msg,
                              sim_message_t *response) {
    // å®ç°SPIå¯„å­˜å™¨è¯»å†™é€»è¾‘
}

simulator_plugin_t* create_spi_plugin(void) {
    // è¿”å›SPIæ’ä»¶å®ä¾‹
}
```

#### 4. æ³¨å†Œåˆ°ç³»ç»Ÿ
```c
// main.c - simulator_init()ä¸­æ·»åŠ 
simulator_plugin_t *spi_plugin = create_spi_plugin();
register_plugin(spi_plugin);
```

## âœ¨ æ ¸å¿ƒç‰¹æ€§

- **ğŸ”„ é©±åŠ¨é€æ˜æ€§**: é©±åŠ¨ä»£ç æ— éœ€ä¿®æ”¹ï¼Œç›´æ¥è¿è¡Œ
- **ğŸ§© æ’ä»¶åŒ–æ¶æ„**: æ¨¡å—åŒ–è®¾è®¡ï¼Œæ˜“äºæ‰©å±•æ–°ç¡¬ä»¶
- **ğŸ¯ é«˜ä»¿çœŸåº¦**: ç²¾ç¡®æ¨¡æ‹Ÿå¯„å­˜å™¨è®¿é—®å’Œä¸­æ–­æ—¶åº  
- **âš¡ é«˜æ€§èƒ½**: å†…å­˜ä¿æŠ¤æœºåˆ¶ï¼Œé›¶æ‹·è´æ•°æ®ä¼ è¾“
- **ğŸ”§ æ˜“é…ç½®**: é™æ€è¡¨é…ç½®ï¼Œç¼–è¯‘æ—¶ä¼˜åŒ–
- **ğŸ“¦ è·¨å¹³å°**: åŸºäºæ ‡å‡†C99ï¼Œæ”¯æŒLinux/Unixç³»ç»Ÿ

## ğŸ› ï¸ æŠ€æœ¯ç‰¹è‰²

1. **å†…å­˜ä¿æŠ¤é©±åŠ¨çš„é€æ˜ä»¿çœŸ**: ä½¿ç”¨mmap + PROT_NONEå®ç°é›¶ä¾µå…¥çš„å¯„å­˜å™¨è®¿é—®æ‹¦æˆª
2. **ä¿¡å·é©±åŠ¨çš„ä¸­æ–­ç³»ç»Ÿ**: ä½¿ç”¨POSIXä¿¡å·æ¨¡æ‹Ÿç¡¬ä»¶ä¸­æ–­ï¼Œæ”¯æŒå¼‚æ­¥å¤„ç†
3. **é…ç½®é©±åŠ¨çš„ç³»ç»Ÿæ¶æ„**: é€šè¿‡é™æ€è¡¨é…ç½®ç³»ç»Ÿè¡Œä¸ºï¼Œæ”¯æŒç¼–è¯‘æ—¶ä¼˜åŒ–
4. **æ’ä»¶åŒ–çš„ç¡¬ä»¶æŠ½è±¡**: æ¯ä¸ªç¡¬ä»¶æ¨¡å—ç‹¬ç«‹å®ç°ï¼Œæ”¯æŒçƒ­æ’æ‹”å’ŒåŠ¨æ€åŠ è½½

## âš ï¸ ç³»ç»Ÿè¦æ±‚

- **æ“ä½œç³»ç»Ÿ**: Linux/Unix/WSLç¯å¢ƒ
- **ç¼–è¯‘å™¨**: GCC (æ”¯æŒC99æ ‡å‡†)
- **ç³»ç»Ÿç‰¹æ€§**: POSIXä¿¡å·æ”¯æŒã€å†…å­˜æ˜ å°„åŠŸèƒ½
- **æ„å»ºå·¥å…·**: Make

### Windowsç¯å¢ƒ
åœ¨Windowsç¯å¢ƒä¸‹ï¼Œå»ºè®®ä½¿ç”¨WSL (Windows Subsystem for Linux) æ¥è¿è¡Œæœ¬é¡¹ç›®ã€‚

## ğŸ¤ è´¡çŒ®æŒ‡å—

1. Fork æœ¬ä»“åº“
2. åˆ›å»ºç‰¹æ€§åˆ†æ”¯ (`git checkout -b feature/AmazingFeature`)
3. æäº¤æ›´æ”¹ (`git commit -m 'Add some AmazingFeature'`)
4. æ¨é€åˆ†æ”¯ (`git push origin feature/AmazingFeature`)
5. åˆ›å»º Pull Request

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ - æŸ¥çœ‹ [LICENSE](LICENSE) æ–‡ä»¶äº†è§£è¯¦æƒ…ã€‚

## ğŸ¯ æœªæ¥è§„åˆ’

- [ ] æ”¯æŒæ›´å¤šå¤–è®¾æ¨¡å— (SPI, I2C, Timerç­‰)
- [ ] æ·»åŠ å›¾å½¢åŒ–è°ƒè¯•ç•Œé¢
- [ ] æ”¯æŒè„šæœ¬åŒ–æµ‹è¯•ç”¨ä¾‹
- [ ] å¢å¼ºè·¨å¹³å°å…¼å®¹æ€§
- [ ] æ”¯æŒåŠ¨æ€æ’ä»¶åŠ è½½
- [ ] æ·»åŠ æ€§èƒ½åˆ†æå·¥å…·

---

**æ¬¢è¿â­ï¸Staræœ¬é¡¹ç›®ï¼Œå¦‚æœ‰é—®é¢˜è¯·æäº¤Issueï¼**
